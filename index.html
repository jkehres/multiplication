<!DOCTYPE html>
<html>
<head>
    <title>Multiplication</title>
    <style>
        body {
            font-size: 8vw;
            font-family: sans-serif;
        }
    </style>
    <script>
        const LOWER = 0;
        const UPPER = 7;
        const SHOW_ANSWER_DELAY = 500;
        const SHOW_CORRECT_DELAY = 1500;
        const RUN_LOCAL = false;
        
        let correct;
        let recognition;
        let show = 'none';
        let listening = false;
        let allowed = true;
        let ignore = false;

        function randomInt(lower, upper) {
            const range = upper - lower + 1;
            return Math.floor(Math.random() * range) + lower;
        }

        function isIntegerString(value) {
            return value && Number.parseInt(value, 10).toString() === value;
        }

        function init() {
            if (window.webkitSpeechRecognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;

                recognition.onresult = resultHandler;
                recognition.onnomatch = () => showAnswer('???');
                recognition.onerror = errorHandler;
                recognition.onend = endHandler;

                document.body.onkeyup = keyHandler;
                reset();
            } else {
                alert('Browser does not support speech API');
            }
        }

        function start() {
            if (allowed) {
                console.log('start');
                listening = true;
                recognition.start();
            }
        }

        function stop() {
            console.log('stop');
            recognition.stop();
        }

        function keyHandler(event) {
            switch (event.key) {
                case 'n':
                    if (show === 'none') {
                        showCorrect();
                    }
                    break;
                case ' ':
                    if (show === 'none') {
                        console.log('ignore');
                        ignore = true;
                    }
                    break;
            }
        }

        function errorHandler(event) {
            console.log(event);
            allowed = event.error !== 'not-allowed' && event.error !== 'service-not-allowed';
        }

        function endHandler() {
            console.log('end');
            listening = false;
            if (RUN_LOCAL) {
                start();
            }
        }

        function resultHandler(event) {
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const result = event.results[i];
                if (result.isFinal) {
                    for (const r of result) {
                        console.log(`i=${i}, c=${r.confidence}, t='${r.transcript.trim()}'`);
                    }

                    let value = result[0].transcript.trim();
                    if (value === 'sex') {
                        value = '6';
                    }
                    if (value === 'hero' || value === 'Euro' || value === 'gyro') {
                        value = '0';
                    }
                    if (value === 'or') {
                        value = '4';
                    }

                    showAnswer(value);
                }
            }
        }

        function reset() {
            if (!listening) {
                start();
            }

            const num1 = randomInt(LOWER, UPPER);
            const num2 = randomInt(LOWER, UPPER);
            correct = (num1 * num2).toString();

            const question = document.getElementById('question');
            const answer = document.getElementById('answer');

            question.innerHTML = `${num1} x ${num2}`;
            answer.style.display = 'none';
            show = 'none';
        }

        function showCorrect() {
            if (!RUN_LOCAL && listening) {
                stop();
            }

            const answer = document.getElementById('answer');
            answer.innerHTML = correct;
            answer.style.display = 'block';
            answer.style.color = 'black';
            show = 'correct';

            setTimeout(reset, SHOW_CORRECT_DELAY);
        }

        function showAnswer(value) {
            if (show !== 'none') {
                return;
            }

            if (!RUN_LOCAL && listening) {
                stop();
            }

            const answer = document.getElementById('answer');
            answer.innerHTML = value;
            answer.style.display = 'block';
            show = 'answer';

            let clearAnswer;
            if (!ignore && isIntegerString(value)) {
                if (value === correct) {
                    answer.style.color = 'green';
                    clearAnswer = reset;
                } else {
                    answer.style.color = 'red';
                    clearAnswer = showCorrect;
                }
            } else {
                ignore = false;
                answer.style.color = value ? 'lightgray' : 'black';
                clearAnswer = hideAnswer;
            }

            setTimeout(clearAnswer, SHOW_ANSWER_DELAY);
        }

        function hideAnswer() {
            const answer = document.getElementById('answer');
            answer.style.display = 'none';
            show = 'none';
        }
    </script>
</head>
<body onload="init()">
    <div id="question"></div>
    <div id="answer"></div>
</body>
</html>